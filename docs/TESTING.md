# üß™ Gu√≠a de Pruebas - Finanzas Personales

Esta gu√≠a documenta todas las pruebas implementadas en el proyecto, incluyendo pruebas manuales, automatizadas, y estrategias de testing.

## üìã √çndice

- [Testing del Asistente de Voz](#testing-del-asistente-de-voz)
- [Testing de NLP Service](#testing-de-nlp-service)
- [Testing de Integraci√≥n](#testing-de-integraci√≥n)
- [Testing Manual](#testing-manual)
- [CI/CD Pipeline](#cicd-pipeline)
- [Testing de Base de Datos](#testing-de-base-de-datos)

---

## üé§ Testing del Asistente de Voz

### Pruebas Funcionales

#### 1. Transcripci√≥n de Voz
**Objetivo**: Verificar que Web Speech API transcribe correctamente

**Casos de Prueba**:
```javascript
// Caso 1: Comando simple de gasto
Input: "gast√© 50000 en comida"
Expected: Transcripci√≥n exacta del comando

// Caso 2: Comando de ingreso
Input: "recib√≠ 1000000 de salario"
Expected: Transcripci√≥n exacta del comando

// Caso 3: Comando con n√∫meros complejos
Input: "pagu√© ochenta mil pesos en transporte"
Expected: Transcripci√≥n puede variar (80000 o "ochenta mil")
```

#### 2. Procesamiento de Comandos
**Objetivo**: Validar que el NLP service procesa correctamente

**Pruebas Automatizadas** (ejecutar con `npx tsx lib/__tests__/nlp-service.test.ts`):

‚úÖ **37 tests pasando**:
- Detecci√≥n de intenciones (gasto/ingreso)
- Extracci√≥n de montos
- Detecci√≥n de categor√≠as
- Niveles de confianza
- Validaci√≥n de comandos
- Generaci√≥n de confirmaciones
- Generaci√≥n de sugerencias
- Detecci√≥n de correcciones
- Enriquecimiento con datos de BD
- Validaci√≥n de formato backend

#### 3. S√≠ntesis de Voz
**Objetivo**: Verificar respuestas auditivas

**Casos de Prueba**:
```javascript
// Caso 1: Confirmaci√≥n simple
Input: Comando v√°lido
Expected: Audio con confirmaci√≥n clara

// Caso 2: Solicitud de informaci√≥n
Input: Comando incompleto
Expected: Audio solicitando datos faltantes

// Caso 3: M√∫ltiples mensajes
Input: Mensaje + sugerencias
Expected: Ambos audios reproducidos secuencialmente sin cortes
```

### Pruebas de Intenci√≥n

**Test 1: Detecci√≥n de Gastos**
```typescript
parseVoiceCommand("gast√© 50000 pesos en una hamburguesa")
// Expected Output:
{
  intention: "gasto",
  transactionType: "gasto",
  amount: 50000,
  categoryName: "Alimentos",
  description: "gast√© 50000 pesos en una hamburguesa",
  confidence: "alta"
}
```

**Test 2: Detecci√≥n de Ingresos**
```typescript
parseVoiceCommand("recib√≠ 1000000 de salario")
// Expected Output:
{
  intention: "ingreso",
  transactionType: "ingreso",
  amount: 1000000,
  categoryName: "Salario",
  confidence: "alta"
}
```

**Test 3: Detecci√≥n de Transporte**
```typescript
parseVoiceCommand("pagu√© 80000 en transporte")
// Expected Output:
{
  intention: "gasto",
  amount: 80000,
  categoryName: "Transporte",
  confidence: "alta"
}
```

### Pruebas de Validaci√≥n

**Test 4: Comando Completo (V√°lido)**
```typescript
const parsed = parseVoiceCommand("gast√© 50000 en hamburguesa")
const validation = validateParsedCommand(parsed)
// Expected: validation.valid === true
// Expected: validation.missingFields.length === 0
```

**Test 5: Comando Incompleto (Falta Monto)**
```typescript
const parsed = parseVoiceCommand("gast√© en comida")
const validation = validateParsedCommand(parsed)
// Expected: validation.valid === false
// Expected: validation.missingFields.includes("monto")
```

**Test 6: Comando sin Categor√≠a**
```typescript
const parsed = parseVoiceCommand("gast√© 25000")
// Expected: categoryName === undefined
// Expected: confidence === "media"
```

### Pruebas de Confirmaci√≥n y Sugerencias

**Test 7: Generaci√≥n de Mensaje de Confirmaci√≥n**
```typescript
const parsed = parseVoiceCommand("gast√© 50000 en hamburguesa")
const message = generateConfirmationMessage(parsed)
// Expected: message.includes("gasto")
// Expected: message.includes("50")
// Expected: message.includes("Alimentos")
```

**Test 8: Generaci√≥n de Sugerencias**
```typescript
const parsed = parseVoiceCommand("gast√© en comida")
const suggestions = generateSuggestions(parsed)
// Expected: suggestions.length > 0
// Expected: suggestions incluye referencia a "monto"
```

### Pruebas de Correcci√≥n

**Test 9: Detecci√≥n de Correcci√≥n**
```typescript
detectCorrection("no, era 15000")
// Expected Output:
{
  isCorrection: true,
  field: "amount",
  newValue: 15000
}
```

**Test 10: Aplicaci√≥n de Correcci√≥n**
```typescript
const original = parseVoiceCommand("gast√© 50000 en comida")
const correction = detectCorrection("no, era 15000")
const corrected = applyCorrection(original, correction)
// Expected: corrected.amount === 15000
// Expected: otros campos permanecen igual
```

### Pruebas de Contexto Pendiente

**Test 11: Preservaci√≥n de Contexto (M√∫ltiples Cuentas)**
```typescript
// Escenario: Usuario tiene 2 cuentas (Nu, Bancolombia)
Input: "recib√≠ 5000 por ventas"
Expected: Sistema pregunta "¬øEn cu√°l cuenta?"
          Contexto guardado: {amount: 5000, category: "Ventas"}

Input respuesta: "en nu"
Expected: Sistema combina contexto + cuenta
          Resultado: {amount: 5000, category: "Ventas", account: "Nu"}
```

**Logs esperados**:
```
[Voice UI] ===== INICIO DE PROCESAMIENTO =====
[Voice UI] Transcripci√≥n: recib√≠ 5000 por ventas
[Voice UI] Comando pendiente actual (state): null
[Voice UI] Comando pendiente actual (ref): null
[Voice UI] ‚¨ÖÔ∏è Respuesta recibida: {needsAdditionalInfo: true}
[Voice UI] üíæ Guardando comando como pendiente (falta info)

[Voice UI] ===== INICIO DE PROCESAMIENTO =====
[Voice UI] Transcripci√≥n: en nu
[Voice UI] Comando pendiente actual (ref): {amount: 5000, category: "Ventas"}
[Voice UI] ‚û°Ô∏è Enviando respuesta con contexto pendiente
[Voice UI] ‚¨ÖÔ∏è Respuesta recibida: {needsConfirmation: true}
[Voice UI] üßπ Limpiando comando pendiente
```

---

## üß¨ Testing de NLP Service

### Suite de Tests Completa

**Ubicaci√≥n**: `lib/__tests__/nlp-service.test.ts`

**Ejecuci√≥n**:
```bash
npx tsx lib/__tests__/nlp-service.test.ts
```

### Tests Implementados (37 total)

#### Grupo 1: Detecci√≥n de Intenciones (5 tests)
1. ‚úÖ Detectar gasto simple
2. ‚úÖ Detectar ingreso de salario
3. ‚úÖ Detectar gasto en transporte
4. ‚úÖ Detectar gasto en servicios
5. ‚úÖ Comando sin categor√≠a clara

#### Grupo 2: Extracci√≥n de Montos (8 tests)
6. ‚úÖ Monto con puntos: "50.000"
7. ‚úÖ Monto con comas: "50,000"
8. ‚úÖ Monto con espacios: "50 000"
9. ‚úÖ Monto sin separadores: "50000"
10. ‚úÖ Monto con palabra "mil": "50 mil"
11. ‚úÖ Monto con "mill√≥n": "1 mill√≥n"
12. ‚úÖ Monto muy grande: "1500000"
13. ‚úÖ Monto con decimales: "50.50"

#### Grupo 3: Detecci√≥n de Categor√≠as (12 tests)
14. ‚úÖ Alimentos: hamburguesa, pizza, comida
15. ‚úÖ Transporte: taxi, uber, gasolina
16. ‚úÖ Servicios: luz, internet, netflix
17. ‚úÖ Salario: salario, sueldo, n√≥mina
18. ‚úÖ Salud: medicina, doctor, farmacia
19. ‚úÖ Entretenimiento: cine, juegos
20. ‚úÖ Educaci√≥n: universidad, libro
21. ‚úÖ Vivienda: arriendo, renta
22. ‚úÖ Ropa: camisa, zapatos
23. ‚úÖ Otros: varios, general
24. ‚úÖ Freelance: trabajo, consultor√≠a
25. ‚úÖ Ventas: venta, vend√≠

#### Grupo 4: Validaci√≥n (4 tests)
26. ‚úÖ Comando completo v√°lido
27. ‚úÖ Comando sin monto (inv√°lido)
28. ‚úÖ Comando sin categor√≠a (v√°lido si tiene monto)
29. ‚úÖ Comando vac√≠o (inv√°lido)

#### Grupo 5: Confirmaci√≥n y Sugerencias (3 tests)
30. ‚úÖ Generar mensaje de confirmaci√≥n
31. ‚úÖ Generar sugerencias para comando incompleto
32. ‚úÖ Sugerencias contextuales

#### Grupo 6: Correcciones (2 tests)
33. ‚úÖ Detectar correcci√≥n de monto
34. ‚úÖ Aplicar correcci√≥n

#### Grupo 7: Enriquecimiento con BD (2 tests)
35. ‚úÖ Asignar IDs de categor√≠a desde BD
36. ‚úÖ Asignar ID de cuenta (una sola cuenta)

#### Grupo 8: Validaci√≥n Backend (1 test)
37. ‚úÖ Validar formato para crear transacci√≥n

---

## üîó Testing de Integraci√≥n

### Prueba de Conexi√≥n a Base de Datos

**Script**: `scripts/test-connection.js`

**Ejecuci√≥n**:
```bash
node scripts/test-connection.js
```

**Casos de Prueba**:

**Caso 1: Con DATABASE_URL configurado**
```
‚úÖ Conexi√≥n exitosa a Neon
Database: finanzas_db
Host: ep-example-123.us-east-2.aws.neon.tech
```

**Caso 2: Sin DATABASE_URL**
```
‚ö†Ô∏è  No hay DATABASE_URL configurado
Usando datos de demostraci√≥n (mock data)
```

**Caso 3: DATABASE_URL inv√°lido**
```
‚ùå Error de conexi√≥n
Detalles: [error espec√≠fico]
```

### Prueba de API Routes

**Endpoint**: `/api/voice/process-command`

**Test 1: Comando V√°lido**
```bash
curl -X POST http://localhost:3000/api/voice/process-command \
  -H "Content-Type: application/json" \
  -d '{
    "transcription": "gast√© 50000 en comida"
  }'
```

**Expected Response**:
```json
{
  "success": true,
  "message": "Voy a registrar un gasto de $50,000 pesos...",
  "parsedCommand": {
    "intention": "gasto",
    "amount": 50000,
    "categoryName": "Alimentos"
  },
  "needsConfirmation": true
}
```

**Test 2: Comando Incompleto**
```bash
curl -X POST http://localhost:3000/api/voice/process-command \
  -H "Content-Type: application/json" \
  -d '{
    "transcription": "gast√© en comida"
  }'
```

**Expected Response**:
```json
{
  "success": false,
  "message": "Me falta informaci√≥n. monto...",
  "suggestions": ["Por favor indica el monto..."]
}
```

### Prueba de Text-to-Speech

**Endpoint**: `/api/voice/text-to-speech`

**Test**:
```bash
curl -X POST http://localhost:3000/api/voice/text-to-speech \
  -H "Content-Type: application/json" \
  -d '{
    "text": "Hola, soy tu asistente financiero"
  }' \
  --output test-audio.mp3
```

**Validaci√≥n**:
- Archivo `test-audio.mp3` creado
- Tama√±o > 0 bytes
- Audio reproducible
- Voz clara en espa√±ol

---

## üñ±Ô∏è Testing Manual

### Checklist de Pruebas de Usuario

#### Asistente de Voz - Flujo B√°sico
- [ ] Abrir aplicaci√≥n
- [ ] Hacer clic en bot√≥n flotante de micr√≥fono
- [ ] Permitir acceso al micr√≥fono (primera vez)
- [ ] Decir: "gast√© 50000 en comida"
- [ ] Verificar transcripci√≥n mostrada
- [ ] Escuchar confirmaci√≥n de voz
- [ ] Ver informaci√≥n detectada en pantalla
- [ ] Hacer clic en "Confirmar"
- [ ] Verificar mensaje de √©xito
- [ ] Verificar transacci√≥n en lista

#### Asistente de Voz - Comando Incompleto
- [ ] Decir: "gast√© en comida"
- [ ] Escuchar solicitud de informaci√≥n faltante
- [ ] Ver sugerencias en pantalla
- [ ] Hacer clic en "Responder de nuevo"
- [ ] Decir: "50000"
- [ ] Verificar que combina la informaci√≥n
- [ ] Confirmar transacci√≥n

#### Asistente de Voz - M√∫ltiples Cuentas
- [ ] Tener al menos 2 cuentas creadas (ej: Nu, Bancolombia)
- [ ] Decir: "recib√≠ 5000 por ventas"
- [ ] Sistema pregunta: "¬øEn cu√°l cuenta?"
- [ ] Ver sugerencias: "en nu", "en bancolombia"
- [ ] Hacer clic en "Responder de nuevo"
- [ ] Decir: "en nu"
- [ ] Verificar que muestra todos los datos: monto + categor√≠a + cuenta
- [ ] Confirmar y verificar transacci√≥n creada en cuenta Nu

#### Asistente de Voz - Correcci√≥n
- [ ] Decir: "gast√© 50000 en comida"
- [ ] Ver confirmaci√≥n
- [ ] Hacer clic en "Corregir"
- [ ] Decir: "no, era 15000"
- [ ] Verificar que monto se actualiz√≥ a 15000
- [ ] Confirmar transacci√≥n corregida

#### Consultas por Voz
- [ ] Decir: "cu√°l es mi balance"
- [ ] Escuchar respuesta con balance total
- [ ] Decir: "cu√°nto gast√© hoy"
- [ ] Escuchar total de gastos del d√≠a
- [ ] Decir: "cu√°l fue mi √∫ltimo gasto"
- [ ] Escuchar detalles del √∫ltimo gasto

#### Control de Audio
- [ ] Iniciar comando de voz
- [ ] Mientras reproduce audio de confirmaci√≥n
- [ ] Hacer clic en "Detener audio"
- [ ] Verificar que el audio se detiene inmediatamente

---

## ‚öôÔ∏è CI/CD Pipeline

### GitHub Actions Workflow

**Archivo**: `.github/workflows/ci.yml`

**Jobs Ejecutados**:

#### 1. Lint (ESLint)
```yaml
- Verifica c√≥digo con ESLint
- Detecta errores de sintaxis
- Valida reglas de estilo
```

**Comando**: `npm run lint`

#### 2. Type Check (TypeScript)
```yaml
- Compila TypeScript sin generar archivos
- Verifica tipos en todo el proyecto
- Detecta errores de tipado
```

**Comando**: `npx tsc --noEmit`

#### 3. Build (Next.js)
```yaml
- Construye aplicaci√≥n para producci√≥n
- Verifica que no hay errores de build
- Valida todas las rutas y componentes
```

**Comando**: `npm run build`

#### 4. Validate Structure
```yaml
- Verifica archivos requeridos existan
- Valida estructura de documentaci√≥n
- Confirma presencia de README, LICENSE, etc.
```

#### 5. Security Check
```yaml
- Escanea c√≥digo en busca de secrets expuestos
- Detecta API keys, contrase√±as, tokens
- Previene commits de informaci√≥n sensible
```

### Triggers del Pipeline

```yaml
on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
```

**Ejecuci√≥n**:
- Cada push a `main` o `develop`
- Cada Pull Request a estas branches
- Manualmente desde GitHub Actions tab

### Badges de Estado

```markdown
[![Build Status](https://github.com/ManuhCardoso1501/FinanzasPersonales-PyI-II/actions/workflows/ci.yml/badge.svg)](https://github.com/ManuhCardoso1501/FinanzasPersonales-PyI-II/actions/workflows/ci.yml)
```

---

## üóÑÔ∏è Testing de Base de Datos

### Pruebas de Queries

#### Test 1: Obtener Todas las Cuentas
```typescript
const accounts = await dbQueries.getAccounts()
// Expected: Array de cuentas
// Expected: Cada cuenta tiene {id, name, type, balance}
```

#### Test 2: Crear Transacci√≥n
```typescript
const transaction = await dbQueries.createTransaction({
  type: "gasto",
  amount: 50000,
  categoryId: 1,
  accountId: 1,
  description: "Test"
})
// Expected: Transaction creada con ID
// Expected: Balance de cuenta actualizado
```

#### Test 3: Conversi√≥n de Tipos
```typescript
// PostgreSQL retorna NUMERIC como string
const account = await dbQueries.getAccountById(1)
const balance = Number(account.balance)
// Expected: balance es tipo number
// Expected: operaciones matem√°ticas funcionan correctamente
```

### Validaci√≥n de Tipo de Datos

**Problema Conocido**: PostgreSQL retorna `NUMERIC` como string

**Soluci√≥n Implementada**:
```typescript
// Siempre convertir a n√∫mero antes de operaciones
const totalBalance = accounts.reduce((sum, account) => {
  return sum + Number(account.balance) // ‚úì Conversi√≥n expl√≠cita
}, 0)
```

**Tests de Regresi√≥n**:
- ‚úÖ Balance total se calcula correctamente
- ‚úÖ No hay concatenaci√≥n de strings (ej: "0" + "5000" = "05000")
- ‚úÖ toLocaleString() funciona correctamente
- ‚úÖ Consultas de voz muestran montos correctos

---

## üìä M√©tricas de Testing

### Cobertura de Tests

| Componente | Tests | Estado |
|-----------|-------|--------|
| NLP Service | 37 | ‚úÖ 100% |
| Voice Recorder Hook | Manual | ‚úÖ |
| API Routes | Manual | ‚úÖ |
| Database Queries | Manual | ‚úÖ |
| UI Components | Manual | ‚úÖ |

### Test Results

```
‚úÖ Total Tests: 37
‚úÖ Passing: 37
‚ùå Failing: 0
‚è≠Ô∏è  Skipped: 0
```

---

## üêõ Debugging y Troubleshooting

### Logs de Debugging

**Activar logs en desarrollo**:
```typescript
// Voice Assistant logs autom√°ticos
[Voice UI] ===== INICIO DE PROCESAMIENTO =====
[Voice UI] Transcripci√≥n: ...
[Voice UI] ‚û°Ô∏è Enviando respuesta con contexto pendiente
[Voice UI] ‚¨ÖÔ∏è Respuesta recibida
[Voice UI] üíæ Guardando comando como pendiente
[Voice UI] üßπ Limpiando comando pendiente
[Voice UI] ===== FIN DE PROCESAMIENTO =====

// Backend logs
[Voice] Transacci√≥n creada: ID=X, Tipo=ingreso, Monto=5000
[Voice] Actualizando balance: Cuenta=1 (Nu), Balance anterior=100000
[Voice] Balance actualizado exitosamente
```

### Problemas Comunes y Soluciones

**Problema 1: Audio se corta**
```typescript
// Soluci√≥n: Detener audio anterior antes de reproducir nuevo
if (audioRef.current && !audioRef.current.paused) {
  audioRef.current.pause()
}
```

**Problema 2: Contexto se pierde**
```typescript
// Soluci√≥n: Usar useRef para preservar estado entre renders
const pendingCommandRef = useRef<ParsedVoiceCommand | null>(null)
useEffect(() => {
  pendingCommandRef.current = pendingCommand
}, [pendingCommand])
```

**Problema 3: Balance muestra "05000" en vez de "5000"**
```typescript
// Soluci√≥n: Convertir a Number antes de operaciones
const total = transactions.reduce((sum, t) => 
  sum + Number(t.amount), 0  // ‚úì Conversi√≥n expl√≠cita
)
```

---

## üìù Conclusi√≥n

El proyecto cuenta con una cobertura de testing exhaustiva que incluye:

- ‚úÖ 37 tests automatizados del servicio NLP
- ‚úÖ Pipeline de CI/CD con 5 jobs
- ‚úÖ Tests manuales documentados
- ‚úÖ Scripts de validaci√≥n de BD
- ‚úÖ Logging completo para debugging

**Estado General**: ‚úÖ Todos los tests pasando

**Pr√≥ximos Pasos**:
- Agregar tests E2E con Playwright
- Implementar tests de performance
- Agregar tests de accesibilidad
- Configurar coverage reports autom√°ticos
